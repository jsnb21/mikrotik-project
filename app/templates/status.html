{% extends "base.html" %}

{% block content %}
<div class="flex flex-col items-center justify-center pt-8 pb-12 w-full">
    
    <div class="text-center mb-10">
        <h1 id="statusTitle" class="text-5xl font-bold text-gray-900 mb-2">
            You are now <span class="text-green-500">Connected</span>
        </h1>
        <p id="statusMessage" class="text-2xl font-bold text-gray-800">Enjoy Browsing! ðŸ’–</p>
    </div>
    
    <!-- Circular Timer Container -->
    <div class="relative w-72 h-72">
        <!-- SVG Ring -->
        <svg class="w-full h-full transform -rotate-90">
            <!-- Background Ring -->
            <circle
                id="bgRing"
                cx="144"
                cy="144"
                r="120"
                stroke="#10B981"
                stroke-width="18"
                fill="transparent"
                class="opacity-20"
            />
            <!-- Progress Ring -->
            <circle
                id="progressRing"
                cx="144"
                cy="144"
                r="120"
                stroke="#10B981"
                stroke-width="18"
                fill="transparent"
                stroke-linecap="round"
                class="transition-all duration-1000 ease-linear"
                style="stroke-dasharray: 754; stroke-dashoffset: 0;"
            />
        </svg>
        
        <!-- Center Content -->
        <div class="absolute top-0 left-0 w-full h-full flex flex-col items-center justify-center text-gray-800">
            <!-- Voucher Code -->
            <div class="text-base font-bold uppercase tracking-widest text-gray-700 mb-1">{{ voucher.code }}</div>
            
            <!-- Big Timer -->
            <div id="timer" class="text-4xl font-bold mb-1 tabular-nums">--:--:--</div>
            
            <!-- Expiry -->
            <div class="text-xs font-bold text-gray-500 uppercase">Expires In</div>
            <div id="expiryDisplay" class="text-lg font-bold text-gray-900">--:--</div>
        </div>
    </div>
    
    <div class="mt-12 text-center text-gray-400 text-sm">
        <p>MAC: {{ voucher.user_mac_address }}</p>
        
        <!-- Back to Home Button (Hidden by default, shown on expiry) -->
        <div id="homeButtonContainer" class="hidden mt-6">
            <a href="{{ url_for('main.index') }}" 
               class="inline-block px-8 py-3 bg-gray-900 text-white text-sm font-bold rounded-full hover:bg-gray-800 transition shadow-lg uppercase tracking-wide">
                Back to Home
            </a>
        </div>
    </div>

</div>

<script>
    // Initial server values
    const remainingSecondsInitial = Number("{{ voucher.remaining_seconds }}");
    const totalDuration = Number("{{ voucher.duration_minutes * 60 }}");
    
    // SVG Config
    const circle = document.getElementById('progressRing');
    const radius = 120;
    const circumference = 2 * Math.PI * radius;
    
    // Set initial dasharray
    circle.style.strokeDasharray = `${circumference}`;
    
    let remaining = remainingSecondsInitial;
    let timerInterval;

    function formatTime(seconds) {
        if (seconds <= 0) return "00:00:00";
        const h = Math.floor(seconds / 3600);
        const m = Math.floor((seconds % 3600) / 60);
        const s = Math.floor(seconds % 60);
        return [
            h.toString().padStart(2, '0'),
            m.toString().padStart(2, '0'),
            s.toString().padStart(2, '0')
        ].join(':');
    }

    function updateDisplay() {
        const timerEl = document.getElementById('timer');
        
        timerEl.innerText = formatTime(remaining);
        
        // Update Ring
        if (totalDuration > 0) {
            // Invert logic: Full circle = full time. As remaining decreases, offset increases.
            // 100% remaining -> offset 0
            // 0% remaining -> offset circumference
            
            const offset = circumference - (remaining / totalDuration) * circumference;
            circle.style.strokeDashoffset = offset;
            
            // Color Shift on low time
            if (remaining < 300) { // last 5 mins
                circle.setAttribute('stroke', '#EF4444'); // Red
            }
        }
    }

    function handleExpiry() {
        // 1. Setup UI Text
        const title = document.getElementById('statusTitle');
        if(title) title.innerHTML = 'You have been <span class="text-red-500">Disconnected</span>';
        
        const msg = document.getElementById('statusMessage');
        if(msg) msg.innerText = 'Your voucher had expired! ðŸ’”';

        // 2. Set Timer to Zero
        const timerEl = document.getElementById('timer');
        if(timerEl) timerEl.innerText = "00:00:00";

        // 3. Gray Rings (Closed Loop Look)
        const fgRing = document.getElementById('progressRing');
        if(fgRing) {
            fgRing.setAttribute('stroke', '#6B7280'); // Gray-500
            fgRing.classList.remove('text-green-500', 'text-yellow-500', 'text-red-500'); // Clean up
            fgRing.style.strokeDashoffset = 0; // Full Circle
        }
        
        const bgRing = document.getElementById('bgRing');
        if(bgRing) {
            bgRing.setAttribute('stroke', '#6B7280');
            bgRing.classList.remove('opacity-20');
            // bgRing.classList.add('opacity-50'); 
        }

        // 4. Show Back to Home Button
        const homeBtn = document.getElementById('homeButtonContainer');
        if(homeBtn) homeBtn.classList.remove('hidden');
    }

    function startTimer() {
        // Set expiry display local time
        const expiryDate = new Date();
        expiryDate.setSeconds(expiryDate.getSeconds() + remaining);
        
        // Format like 1:39PM
        const timeString = expiryDate.toLocaleTimeString([], {
            hour: 'numeric', 
            minute:'2-digit',
            hour12: true
        }).replace(' ', ''); 
        
        document.getElementById('expiryDisplay').innerText = timeString;

        // Initial Check
        if (remaining <= 0) {
            handleExpiry();
            return;
        }

        updateDisplay();
        
        timerInterval = setInterval(() => {
            remaining--;
            if (remaining <= 0) {
                clearInterval(timerInterval);
                remaining = 0;
                handleExpiry();
            } else {
                updateDisplay();
            }
        }, 1000);
    }
    
    // Sync with server every minute check
    async function syncStatus() {
        try {
            const res = await fetch(`/api/status/{{ voucher.code }}`);
            const data = await res.json();
            if (data.active) {
                // Adjust if drift is large (> 5 seconds)
                if (Math.abs(remaining - data.remaining_seconds) > 5) {
                    remaining = data.remaining_seconds;
                }
            } else {
                 remaining = 0; // force expiry
            }
        } catch(e) {
            console.log("Sync error", e);
        }
    }

    startTimer();
    setInterval(syncStatus, 30000); // Sync every 30s
</script>
{% endblock %}
