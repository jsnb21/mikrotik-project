{% extends "base.html" %}

{% block content %}
<div class="container mx-auto p-4 md:p-8">
    <!-- Header Area -->
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
        <div>
            <h1 class="text-4xl font-black text-[#0b343d] uppercase tracking-tighter">Network Dashboard</h1>
            <p class="text-gray-600 font-medium">Monitoring MikroTik Router via ROS API</p>
        </div>
        <a href="{{ url_for('admin.settings') }}" class="flex items-center gap-2 text-[#0b343d] font-black uppercase text-xs tracking-widest hover:translate-x-[4px] transition-transform">
            Settings
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M10 19l7-7m0 0l-7-7m7 7H3"></path></svg>
        </a>
    </div>

    <!-- Tabs Navigation -->
    <div class="mb-8 overflow-x-auto">
        <nav class="flex space-x-2 bg-white p-1 rounded-xl w-fit shadow-sm" aria-label="Tabs">
            <button onclick="switchTab('network')" id="tab-network" class="tab-btn px-6 py-3 rounded-lg font-bold text-sm transition-all duration-200 bg-[#ffd41d] text-black">
                System Status
            </button>
            <button onclick="switchTab('finance')" id="tab-finance" class="tab-btn px-6 py-3 rounded-lg font-bold text-sm transition-all duration-200 text-gray-500 hover:text-gray-900">
                Income Analytics
            </button>
            <button onclick="switchTab('sessions')" id="tab-sessions" class="tab-btn px-6 py-3 rounded-lg font-bold text-sm transition-all duration-200 text-gray-500 hover:text-gray-900">
                Active Users
            </button>
        </nav>
    </div>

    <!-- Network Tab -->
    <div id="content-network" class="tab-content transition-opacity duration-300">
        <!-- System Stats Grid -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="bg-white p-6 rounded-2xl shadow-xl border-b-4 border-blue-500">
                <p class="text-[10px] uppercase font-black text-gray-400 mb-1">System Uptime</p>
                <p class="text-xl font-black text-[#0b343d]">{{ system_stats.uptime }}</p>
            </div>
            <div class="bg-white p-6 rounded-2xl shadow-xl border-b-4 border-green-500">
                <p class="text-[10px] uppercase font-black text-gray-400 mb-1">CPU Load</p>
                <div class="flex items-end gap-2">
                    <span class="text-3xl font-black text-[#0b343d]">{{ system_stats.cpu_load }}%</span>
                    <div class="w-full h-2 bg-gray-100 rounded-full mb-2">
                        <div class="h-2 bg-green-500 rounded-full" style="--width: {{ system_stats.cpu_load }}%; width: var(--width);"></div>
                    </div>
                </div>
            </div>
             <div class="bg-white p-6 rounded-2xl shadow-xl border-b-4 border-purple-500">
                <p class="text-[10px] uppercase font-black text-gray-400 mb-1">Free Memory</p>
                <p class="text-3xl font-black text-[#0b343d]">{{ (system_stats.free_memory / 1024 / 1024)|round(1) }} <span class="text-sm">MB</span></p>
            </div>
            <div class="bg-white p-6 rounded-2xl shadow-xl border-b-4 border-[#ffd41d]">
                <p class="text-[10px] uppercase font-black text-gray-400 mb-1">Board Model</p>
                <p class="text-xl font-black text-[#0b343d] truncate">{{ system_stats.board_name }}</p>
            </div>
        </div>

        <div class="grid grid-cols-1 xl:grid-cols-3 gap-8 mb-8">
            <!-- Interface Traffic -->
            <div class="bg-white p-8 rounded-2xl shadow-xl col-span-1">
                 <h2 class="text-xl font-black text-[#0b343d] mb-6 uppercase tracking-tight flex items-center gap-2">
                    <div class="w-2 h-6 bg-[#ffd41d]"></div>
                    Traffic Live
                 </h2>
                 <div class="space-y-6">
                     <div class="p-6 bg-gray-50 rounded-2xl border border-gray-100">
                         <div class="text-xs uppercase font-bold text-gray-500 mb-1">Download (RX)</div>
                         <div class="text-4xl font-black text-green-600 font-mono">{{ (traffic.rx_bps / 1000000)|round(2) }}<span class="text-lg">Mbps</span></div>
                     </div>
                     <div class="p-6 bg-gray-50 rounded-2xl border border-gray-100">
                         <div class="text-xs uppercase font-bold text-gray-500 mb-1">Upload (TX)</div>
                         <div class="text-4xl font-black text-blue-600 font-mono">{{ (traffic.tx_bps / 1000000)|round(2) }}<span class="text-lg">Mbps</span></div>
                     </div>
                 </div>
            </div>

            <!-- Charts Placeholder -->
            <div class="bg-white p-8 rounded-2xl shadow-xl col-span-1 xl:col-span-2">
                <h2 class="text-xl font-black text-[#0b343d] mb-6 uppercase tracking-tight flex items-center gap-2">
                    <div class="w-2 h-6 bg-[#0b343d]"></div>
                    Traffic History
                </h2>
                <div class="h-80">
                    <canvas id="trafficChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Finance Tab -->
    <div id="content-finance" class="tab-content hidden transition-opacity duration-300">
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="bg-[#ffd41d] p-6 rounded-2xl shadow-xl border-b-4 border-black">
                <p class="text-[10px] uppercase font-black text-black/60 mb-1">Earned Today</p>
                <p class="text-3xl font-black text-black">₱{{ "{:,}".format(income_stats.earned_today) }}</p>
            </div>
            <div class="bg-white p-6 rounded-2xl shadow-xl border-b-4 border-[#0b343d]">
                <p class="text-[10px] uppercase font-black text-gray-400 mb-1">This Month</p>
                <p class="text-3xl font-black text-[#0b343d]">₱{{ "{:,}".format(income_stats.earned_month) }}</p>
            </div>
            <div class="bg-white p-6 rounded-2xl shadow-xl border-b-4 border-[#0b343d]">
                <p class="text-[10px] uppercase font-black text-gray-400 mb-1">Total Year</p>
                <p class="text-3xl font-black text-[#0b343d]">₱{{ "{:,}".format(income_stats.earned_year) }}</p>
            </div>
            <div class="bg-white p-6 rounded-2xl shadow-xl border-b-4 border-[#0b343d]">
                <p class="text-[10px] uppercase font-black text-gray-400 mb-1">Daily Average</p>
                <p class="text-3xl font-black text-[#0b343d]">₱{{ "{:,}".format(income_stats.average_daily) }}</p>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            <div class="bg-white p-8 rounded-2xl shadow-xl">
                <h2 class="text-xl font-black text-[#0b343d] mb-6 uppercase tracking-tight">Daily Income (7d)</h2>
                <div class="h-80">
                    <canvas id="dailyIncomeChart"></canvas>
                </div>
            </div>
            <div class="bg-white p-8 rounded-2xl shadow-xl">
                <h2 class="text-xl font-black text-[#0b343d] mb-6 uppercase tracking-tight">Monthly Growth</h2>
                <div class="h-80">
                    <canvas id="monthlyIncomeChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Sessions Tab -->
    <div id="content-sessions" class="tab-content hidden transition-opacity duration-300">
        <div class="bg-white rounded-2xl shadow-xl overflow-hidden">
            <div class="p-8 border-b border-gray-100 flex justify-between items-center">
                <h2 class="text-xl font-black text-[#0b343d] uppercase tracking-tight">Active Hotspot Users</h2>
                <span class="bg-[#ffd41d] text-black px-4 py-1 rounded-full text-xs font-black">{{ active_users|length }} ONLINE</span>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full">
                    <thead>
                        <tr class="bg-gray-50">
                            <th class="px-8 py-5 text-left text-[10px] font-black text-gray-400 uppercase tracking-widest">User</th>
                            <th class="px-8 py-5 text-left text-[10px] font-black text-gray-400 uppercase tracking-widest">MAC Address</th>
                            <th class="px-8 py-5 text-left text-[10px] font-black text-gray-400 uppercase tracking-widest">Uptime</th>
                            <th class="px-8 py-5 text-left text-[10px] font-black text-gray-400 uppercase tracking-widest">Time Left</th>
                            <th class="px-8 py-5 text-left text-[10px] font-black text-gray-400 uppercase tracking-widest">Data Transfer</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-100">
                        {% for user in active_users %}
                        <tr class="hover:bg-gray-50 transition-colors">
                            <td class="px-8 py-6">
                                <span class="text-sm font-black text-[#0b343d]">{{ user.user }}</span>
                            </td>
                            <td class="px-8 py-6">
                                <span class="text-xs font-mono text-gray-500">{{ user.mac }}</span>
                            </td>
                            <td class="px-8 py-6">
                                <span class="px-3 py-1 bg-green-100 text-green-700 rounded-full text-xs font-black uppercase">{{ user.uptime }}</span>
                            </td>
                            <td class="px-8 py-6">
                                <span class="text-sm font-black text-[#ff5f52]">{{ user.time_left }}</span>
                            </td>
                            <td class="px-8 py-6">
                                <div class="flex items-center gap-4">
                                    <div class="text-right">
                                        <p class="text-[10px] font-bold text-gray-400">IN: {{ (user.bytes_in / 1024 / 1024)|round(1) }}MB</p>
                                        <p class="text-[10px] font-bold text-gray-400">OUT: {{ (user.bytes_out / 1024 / 1024)|round(1) }}MB</p>
                                    </div>
                                </div>
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="5" class="px-8 py-12 text-center text-gray-400 font-medium italic">No active users currently connected.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script id="income-data" type="application/json">
    {{ income_stats | tojson }}
</script>
<script>
    const incomeStats = JSON.parse(document.getElementById('income-data').textContent);

    function switchTab(tabName) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
        document.getElementById('content-' + tabName).classList.remove('hidden');
        
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.classList.remove('bg-[#ffd41d]', 'text-black');
            btn.classList.add('text-gray-500', 'hover:text-gray-900');
        });
        
        const activeBtn = document.getElementById('tab-' + tabName);
        activeBtn.classList.add('bg-[#ffd41d]', 'text-black');
        activeBtn.classList.remove('text-gray-500', 'hover:text-gray-900');
    }

    // Chart customization
    Chart.defaults.color = '#9ca3af';
    Chart.defaults.font.family = 'Inter, system-ui, sans-serif';

    const ctx = document.getElementById('trafficChart').getContext('2d');
    const chart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: ['10:00', '10:05', '10:10', '10:15', '10:20', '10:25'],
            datasets: [{
                label: 'Download',
                borderColor: '#10B981',
                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                data: [0, 10, 5, 2, 20, 30, 45],
                fill: true,
                tension: 0.4,
                borderWidth: 3
            }, {
                label: 'Upload',
                borderColor: '#3B82F6',
                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                data: [0, 5, 2, 1, 10, 15, 20],
                fill: true,
                tension: 0.4,
                borderWidth: 3
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { position: 'bottom' } },
            scales: {
                y: { grid: { color: 'rgba(0,0,0,0.05)' } },
                x: { grid: { display: false } }
            }
        }
    });

    const ctxDaily = document.getElementById('dailyIncomeChart').getContext('2d');
    new Chart(ctxDaily, {
        type: 'bar',
        data: {
            labels: incomeStats.labels_daily,
            datasets: [{
                label: 'Earnings (₱)',
                data: incomeStats.daily,
                backgroundColor: '#ffd41d',
                borderRadius: 8
            }]
        },
        options: { 
            responsive: true, 
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: { y: { beginAtZero: true } }
        }
    });

    const ctxMonthly = document.getElementById('monthlyIncomeChart').getContext('2d');
    new Chart(ctxMonthly, {
        type: 'line',
        data: {
            labels: incomeStats.labels_monthly,
            datasets: [{
                label: 'Monthly (₱)',
                data: incomeStats.monthly,
                borderColor: '#0b343d',
                backgroundColor: 'rgba(11, 52, 61, 0.1)',
                tension: 0.4,
                fill: true,
                borderWidth: 4
            }]
        },
        options: { 
            responsive: true, 
            maintainAspectRatio: false,
            plugins: { legend: { display: false } }
        }
    });
</script>
{% endblock %}
