{% extends "base.html" %}

{% block content %}
<div class="flex items-center justify-center p-4" style="min-height: 80vh;">
    <div class="max-w-md w-full bg-white rounded-xl shadow-2xl overflow-hidden">
        <!-- Header -->
        <div class="card-header">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.111 16.404a5.5 5.5 0 017.778 0M12 20h.01m-7.08-7.071c3.904-3.905 10.236-3.905 14.141 0M1.394 9.393c5.857-5.857 15.355-5.857 21.213 0"></path>
            </svg>
            <h1 style="color: var(--confirm-yellow); font-weight: 800; font-size: 2rem;">WIFI PORTAL</h1>
            <p>Enter your voucher code to connect</p>
        </div>

        <!-- Body -->
        <div class="card-body">
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="alert {% if category == 'error' %}alert-error{% else %}alert-success{% endif %}">
                            {{ message }}
                        </div>
                    {% endfor %}
                {% endif %}
            {% endwith %}

            <form action="{{ url_for('client.activate') }}" method="POST" class="space-y-4" id="voucherForm">
                <div>
                    <label for="voucher_code">
                        Voucher Code
                    </label>
                    <input 
                        type="text" 
                        name="voucher_code" 
                        id="voucher_code" 
                        class="voucher-input"
                        placeholder="000000" 
                        maxlength="6"
                        required
                        autofocus
                    >
                    <p class="text-xs text-gray-400 mt-2 text-center font-bold uppercase">Codes are 6 digits/characters</p>
                </div>

                <!-- Hidden fields for MikroTik parameters -->
                {% if mac_address %}
                <input type="hidden" name="mac_address" value="{{ mac_address }}">
                {% endif %}
                {% if ip_address %}
                <input type="hidden" name="ip_address" value="{{ ip_address }}">
                {% endif %}

                <button type="submit" class="btn btn-confirm" id="submitBtn">
                    Connect Now
                </button>

                <!-- Loading text -->
                <div id="loadingSpinner" class="text-center mt-4" style="display: none;">
                    <div class="flex flex-col items-center gap-3">
                        <div class="animate-spin rounded-full h-12 w-12 border-b-4 border-[#16a34a]"></div>
                        <p id="statusMessage" class="text-[#16a34a] font-bold text-lg">Processing Voucher...</p>
                    </div>
                </div>
            </form>

            <div class="mt-6 pt-6 border-t border-gray-100">
                <p class="text-center text-sm text-gray-500 font-medium">
                    No code? Visit the administrator to purchase one.
                </p>
            </div>
            
            {% if mac_address or ip_address %}
            <div class="mt-4 p-4 rounded-lg" style="background: #f8fafc; border: 1px dashed #e2e8f0;">
                <p class="text-[10px] uppercase font-bold text-gray-400 mb-2">Device Info</p>
                <div class="flex justify-between text-[11px] font-mono text-gray-600">
                    <span>MAC: {{ mac_address or 'N/A' }}</span>
                    <span>IP: {{ ip_address or 'N/A' }}</span>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script src="{{ url_for('static', filename='js/notification.js') }}"></script>
<script src="{{ url_for('static', filename='js/voucher_login.js') }}"></script>
<script>
    const form = document.getElementById('voucherForm');
    const submitBtn = document.getElementById('submitBtn');
    const loadingSpinner = document.getElementById('loadingSpinner');
    const statusMessage = document.getElementById('statusMessage');
    
    let isSubmitting = false;
    let redirecting = false;

    const redirectToStatus = (code) => {
        if (redirecting) return;
        redirecting = true;
        window.location.href = '/status?code=' + code;
    };
    
    form.addEventListener('submit', function(e) {
        e.preventDefault(); // Prevent default form submission
        
        if (isSubmitting) {
            return false;
        }
        
        isSubmitting = true;
        submitBtn.disabled = true;
        submitBtn.classList.add('hidden');
        loadingSpinner.style.display = 'block';
        
        // Get form data
        const voucherCode = document.getElementById('voucher_code').value.trim().toUpperCase();
        const formData = new FormData(form);
        
        // Show initial status
        statusMessage.textContent = 'Validating voucher...';
        
        // Submit via FAST API endpoint (no MikroTik wait in request)
        fetch('/api/activate-quick', {
            method: 'POST',
            body: formData,
            cache: 'no-store'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Activation queued in background! Start fast polling immediately
                statusMessage.textContent = 'Authorized! Connecting...';
                let pollCount = 0;
                const maxPolls = 10; // ~3 seconds at 300ms
                const pollInterval = setInterval(function() {
                    pollCount++;
                    const cb = Date.now();
                    
                    // Poll status with cache-busting and no-store
                    fetch(`/api/status/${voucherCode}?cb=${cb}`, { cache: 'no-store' })
                        .then(res => res.json())
                        .then(data => {
                            if (data.active && data.remaining_seconds > 0) {
                                clearInterval(pollInterval);
                                statusMessage.textContent = 'Connected! Redirecting...';
                                setTimeout(() => redirectToStatus(voucherCode), 50);
                            }
                        })
                        .catch(err => console.log('Poll status:', err));

                    // Also try a local ping to detect LAN connectivity early
                    fetch(`/ping?c=${cb}`, { cache: 'no-store' })
                        .then(r => { if (r.ok) { clearInterval(pollInterval); statusMessage.textContent = 'Connected! Redirecting...'; setTimeout(() => redirectToStatus(voucherCode), 50); }})
                        .catch(() => {});
                    
                    if (pollCount >= maxPolls) {
                        clearInterval(pollInterval);
                        statusMessage.textContent = 'Finalizing...';
                        setTimeout(() => redirectToStatus(voucherCode), 400);
                    }
                }, 300);
            } else {
                // Handle errors
                const errorMsg = data.error || 'Activation failed. Please try again.';
                statusMessage.textContent = errorMsg;
                statusMessage.style.color = '#dc2626';
                
                setTimeout(() => {
                    submitBtn.classList.remove('hidden');
                    submitBtn.disabled = false;
                    loadingSpinner.style.display = 'none';
                    isSubmitting = false;
                }, 2000);
            }
        })
        .catch(error => {
            console.error('Activation error:', error);
            statusMessage.textContent = 'Connection error. Please try again.';
            statusMessage.style.color = '#dc2626';
            
            setTimeout(() => {
                submitBtn.classList.remove('hidden');
                submitBtn.disabled = false;
                loadingSpinner.style.display = 'none';
                isSubmitting = false;
            }, 3000);
        });
        
        return false;
    });
</script>
{% endblock %}
